{% extends "base.html" %}
{% block content %}
<div class="page-header">
	<h1>
		add listing
		<a class="btn btn-default" href="/listings">back</a>
	</h1>
</div>
<div id="alerts">
	{% if not inventory.count() and not playlist.count() %}
	<div class="alert alert-info">
		no games in your inventory and playlist!
	</div>
	{% endif %}
</div>
{% if inventory.count() or playlist.count() %}
<form id="form" class="form-horizontal" role="form">
	<div class="row">
		<div class="col-md-6">
			<div class="panel panel-primary">
				<div class="panel-heading">
					<h3 class="panel-title">inventory</h3>
				</div>
				{% if inventory.count() %}
				<div class="table-responsive">
					<table id="inventory" class="sortable table table-bordered table-striped">
						<thead>
							<tr>
								<th class="sorttable_nosort" width="10%"></th>
								<th width="65%" style="text-align: left">title</th>
								<th width="15%">platform</th>
								<th width="10%">picture</th>
							</tr>
						</thead>
						<tbody>
							{% for game in inventory %}
							<tr id="{{ game.key.urlsafe() }}" class="game" title="{{ game.title }}" data-content="<p>description: {{ game.description or 'none' }}</p>">
								<td width="10%"><input type="checkbox" class="own" value="{{ game.key.urlsafe() }}"></td>
								<td width="65%" style="text-align: left">{{ game.title }}</td>
								<td width="15%">{{ game.platform }}</td>
								<td width="10%">
									{% if game.pic %}
									<a class="btn btn-default" href="{{ game.pic }}" target="_blank">
										<span class="glyphicon glyphicon-picture"></span>
									</a>
									{% else %}
									n/a
									{% endif %}
								</td>
							</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>
				{% else %}
				<div class="panel-body">
					<div class="alert alert-info">
						no games in your inventory!
						<a class="btn btn-default btn-sm" href="/inventory/add">
							<span class="glyphicon glyphicon-plus"></span>
						</a>
					</div>
				</div>
				{% endif %}
				<div id="offer" class="panel-footer listing-topup" style="display: none">
					<div class="input-group">
						<span class="input-group-addon">topup $</span>
						<input id="offer-amt" type="number" class="form-control price" step="1" value="0" style="text-align: right">
						<span class="input-group-addon">.00</span>
					</div>
				</div>
			</div>
		</div>
		<div class="col-md-6">
			<div class="panel panel-primary">
				<div class="panel-heading">
					<h3 class="panel-title">playlist</h3>
				</div>
				{% if playlist.count() %}
				<div class="table-responsive">
					<table id="playlist" class="sortable table table-bordered table-striped">
						<thead>
							<tr>
								<th class="sorttable_nosort" width="10%"></th>
								<th width="65%" style="text-align: left">title</th>
								<th width="15%">platform</th>
								<th width="10%">picture</th>
							</tr>
						</thead>
						<tbody>
							{% for game in playlist %}
							<tr id="{{ game.key.urlsafe() }}" class="game" title="{{ game.title }}" data-content="<p>description: {{ game.description or 'none' }}</p>">
								<td width="10%"><input type="checkbox" class="seek" value="{{ game.key.urlsafe() }}"></td>
								<td width="65%" style="text-align: left">{{ game.title }}</td>
								<td width="15%">{{ game.platform }}</td>
								<td width="10%">
									{% if game.pic %}
									<a class="btn btn-default" href="{{ game.pic }}" target="_blank">
										<span class="glyphicon glyphicon-picture"></span>
									</a>
									{% else %}
									n/a
									{% endif %}
								</td>
							</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>
				{% else %}
				<div class="panel-body">
					<div class="alert alert-info">
						no games in your playlist!
						<a class="btn btn-default btn-sm" href="/playlist/add">
							<span class="glyphicon glyphicon-plus"></span>
						</a>
					</div>
				</div>
				{% endif %}
				<div id="request" class="panel-footer listing-topup" style="display: none">
					<div class="input-group">
						<span class="input-group-addon">topup $</span>
						<input id="request-amt" type="number" class="form-control price" step="1" value="0" style="text-align: right">
						<span class="input-group-addon">.00</span>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div class="form-group">
		<label for="description" class="col-sm-2 control-label">description</label>
		<div class="col-sm-10">
			<div class="input-group">
				<span class="input-group-addon">
					<i class="glyphicon glyphicon-italic"></i>
				</span>
				<textarea id="description" class="form-control" rows="3" maxlength="500" placeholder="add more info"></textarea>
			</div>
		</div>
	</div>
	<div class="pull-right">
		<button id="submit" type="button" class="btn btn-default">add</button>
	</div>
</form>
{% endif %}
<script>
	var num_own = 0;
	var num_seek = 0;

	$(':checkbox').change(function() {
		if ($(this).attr('class') == 'own') {
			this.checked ? num_own++ : num_own--;
		} else {
			this.checked ? num_seek++ : num_seek--;
		}

		if (num_own && num_seek) {
			$('#offer-amt').prop('disabled', false);
			$('#offer').slideDown('fast');

			$('#request-amt').prop('disabled', false);
			$('#request').slideDown('fast');
		} else if (num_own) {
			$('#offer-amt').prop('disabled', true);
			$('#offer-amt').val(0);
			$('#offer').slideUp('fast');

			$('#request-amt').prop('disabled', false);
			$('#request').slideDown('fast');
		} else if (num_seek) {
			$('#offer-amt').prop('disabled', false);
			$('#offer').slideDown('fast');

			$('#request-amt').prop('disabled', true);
			$('#request-amt').val(0);
			$('#request').slideUp('fast');
		} else {
			$('#offer-amt').prop('disabled', true);
			$('#offer-amt').val(0);
			$('#offer').slideUp('fast');

			$('#request-amt').prop('disabled', true);
			$('#request-amt').val(0);
			$('#request').slideUp('fast');
		}
	});

	$('#submit').click(function() {
		clearAlerts();
		$('#form :input').prop('disabled', true);

		var listing = {
			own_urls: [],
			seek_urls: [],
			offer_amt: parseInt($('#offer-amt').val()),
			request_amt: parseInt($('#request-amt').val()),
			description: $('#description').val().trim(),
		};

		$('.own').each(function () {
			if (this.checked) {
				listing.own_urls.push(this.value);
			}
		});

		$('.seek').each(function () {
			if (this.checked) {
				listing.seek_urls.push(this.value);
			}
		});

		if (isNaN(listing.offer_amt)) {
			$('#alerts').append(alertBootstrap('danger', 'invalid offer topup amount.'));
		} else if (isNaN(listing.request_amt)) {
			$('#alerts').append(alertBootstrap('danger', 'invalid request topup amount.'));
		} else if (listing.offer_amt > 0 && listing.request_amt > 0) {
			$('#alerts').append(alertBootstrap('danger', 'you cannot offer and request a topup amount at the same time.'));
		} else if (!listing.own_urls.length && !listing.seek_urls.length) {
			$('#alerts').append(alertBootstrap('danger', 'listing cannot be empty.'));
		} else if ((listing.own_urls.length || listing.offer_amt > 0) && !listing.seek_urls.length && listing.request_amt == 0) {
			$('#alerts').append(alertBootstrap('danger', 'add a topup amount or games you want to trade for.'));
		} else if (!listing.own_urls.length  && listing.offer_amt == 0 && (listing.seek_urls.length || listing.request_amt > 0)) {
			$('#alerts').append(alertBootstrap('danger', 'add a topup amount or games you want to trade away.'));
		} else if (listing.description.length > 500) {
			$('#alerts').append(alertBootstrap('danger', 'listing description exceeds 500 characters'));
		} else {
			$.ajax({
				type: 'POST',
				url: '/listings/add',
				data: JSON.stringify(listing),
				contentType: 'application/json',
				success: function(data, textStatus, jqXHR) {
					console.log(data);
					console.log(textStatus);
					console.log(jqXHR);

					$('#alerts').append(alertBootstrap('success', 'listing added.'));
					alertTimeout(5000);

					$('#form')[0].reset()
				},
				error: function(jqXHR, textStatus, errorThrown) {
					console.log(jqXHR);
					console.log(textStatus);
					console.log(errorThrown);
					var errors = eval(jqXHR.responseText);

					for (var i = 0; i < errors.length; i++) {
						$('#alerts').append(alertBootstrap('danger', errors[i]));
					}
				}
			});
		}

		$('#form :input').prop('disabled', false);
	});

	$(document).ready(function(){
		// only allow numbers, backspaces, deletes, tabs to be typed in .price fields
		$(".price").keydown(function (event) {
			if (event.shiftKey) {
				event.preventDefault();
			}

			if (event.keyCode == 46 || event.keyCode == 8 || event.keyCode == 9) {
			}
			else {
				if (event.keyCode < 95) {
					if (event.keyCode < 48 || event.keyCode > 57) {
						event.preventDefault();
					}
				}
				else {
					if (event.keyCode < 96 || event.keyCode > 105) {
						event.preventDefault();
					}
				}
			}
		});
	});
</script>
<script>
	$('.game').popover({
		html: true,
		trigger: 'hover',
		placement: 'right',
	});
</script>
<script>
	$('#nav-list').addClass("active");
	$('#nav-list-add').addClass("active");
</script>
{% endblock %}