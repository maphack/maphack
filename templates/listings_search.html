{% extends "base.html" %}
{% block content %}
<div id="search-div">
	<div class="page-header">
		<h1>
			search listings
			<a class="btn btn-default" href="/listings/add">
				<span class="glyphicon glyphicon-plus"></span>
			</a>
		</h1>
	</div>
	<div id="alerts">
		{% if not inventory.count() and not playlist.count() %}
		<div class="alert alert-info">
			no games in your inventory and playlist!
		</div>
		{% endif %}
	</div>
	{% if inventory.count() or playlist.count() %}
	<form id="form" class="form-horizontal" role="form">
	<div class="row">
		<div class="col-md-6">
			<div class="panel panel-primary">
				<div class="panel-heading">
					<h3 class="panel-title">inventory</h3>
				</div>
				{% if inventory.count() %}
				<div class="table-responsive">
					<table class="sortable table table-bordered table-striped">
						<thead>
							<tr>
								<th class="sorttable_nosort" width="10%" style="text-align: left"></th>
								<th width="75%" style="text-align: left">title</th>
								<th width="15%">platform</th>
							</tr>
						</thead>
						<tbody>
							{% for game in inventory %}
							<tr id="{{ game.key.urlsafe() }}">
								<td width="10%"><input type="checkbox" class="own" value="{{ game.key.urlsafe() }}"></td>
								<td width="75%" style="text-align: left">{{ game.title }}</td>
								<td width="15%">{{ game.platform }}</td>
							</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>
				{% else %}
				<div class="panel-body">
					<div class="alert alert-info">
						no games in your inventory!
						<a class="btn btn-default btn-sm" href="/inventory/add">
							<span class="glyphicon glyphicon-plus"></span>
						</a>
					</div>
				</div>
				{% endif %}
				<div id="offer" class="panel-footer listing-topup" style="display: none">
					<div class="input-group">
						<span class="input-group-addon">topup &#60; $</span>
						<input id="offer-amt" type="number" class="form-control price" step="1" value="0" style="text-align: right">
						<span class="input-group-addon">.00</span>
					</div>
				</div>
			</div>
		</div>
		<div class="col-md-6">
			<div class="panel panel-primary">
				<div class="panel-heading">
					<h3 class="panel-title">playlist</h3>
				</div>
				{% if playlist.count() %}
				<div class="table-responsive">
					<table class="sortable table table-bordered table-striped">
						<thead>
							<tr>
								<th class="sorttable_nosort" width="10%" style="text-align: left"></th>
								<th width="75%" style="text-align: left">title</th>
								<th width="15%">platform</th>
							</tr>
						</thead>
						<tbody>
							{% for game in playlist %}
							<tr id="{{ game.key.urlsafe() }}">
								<td width="10%"><input type="checkbox" class="seek" value="{{ game.key.urlsafe() }}"></td>
								<td width="75%" style="text-align: left">{{ game.title }}</td>
								<td width="15%">{{ game.platform }}</td>
							</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>
				{% else %}
				<div class="panel-body">
					<div class="alert alert-info">
						no games in your playlist!
						<a class="btn btn-default btn-sm" href="/playlist/add">
							<span class="glyphicon glyphicon-plus"></span>
						</a>
					</div>
				</div>
				{% endif %}
				<div id="request" class="panel-footer listing-topup" style="display: none">
					<div class="input-group">
						<span class="input-group-addon">topup > $</span>
						<input id="request-amt" type="number" class="form-control price" step="1" value="0" style="text-align: right">
						<span class="input-group-addon">.00</span>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div class="pull-right">
		<button id="search" type="button" class="btn btn-default">
			<span class="glyphicon glyphicon-search"></span>
		</button>
	</div>
	</form>
	{% endif %}
</div>
<div id="search-results"></div>
<script>
	var num_own = 0;
	var num_seek = 0;

	$(':checkbox').change(function() {
		if ($(this).attr('class') == 'own') {
			this.checked ? num_own++ : num_own--;
		} else {
			this.checked ? num_seek++ : num_seek--;
		}

		if (num_own && num_seek) {
			$('#offer-amt').prop('disabled', false);
			$('#offer').slideDown('fast');

			$('#request-amt').prop('disabled', false);
			$('#request').slideDown('fast');
		} else if (num_own) {
			$('#offer-amt').prop('disabled', true);
			$('#offer-amt').val(0);
			$('#offer').slideUp('fast');

			$('#request-amt').prop('disabled', false);
			$('#request').slideDown('fast');
		} else if (num_seek) {
			$('#offer-amt').prop('disabled', false);
			$('#offer').slideDown('fast');

			$('#request-amt').prop('disabled', true);
			$('#request-amt').val(0);
			$('#request').slideUp('fast');
		} else {
			$('#offer-amt').prop('disabled', true);
			$('#offer-amt').val(0);
			$('#offer').slideUp('fast');

			$('#request-amt').prop('disabled', true);
			$('#request-amt').val(0);
			$('#request').slideUp('fast');
		}
	});

	$('#search').click(function() {
		clearAlerts();
		$('#form :input').prop('disabled', true);

		var listing = {
			own_urls: [],
			seek_urls: [],
			offer_amt: parseInt($('#offer-amt').val()),
			request_amt: parseInt($('#request-amt').val()),
		};

		$('.own').each(function () {
			if (this.checked) {
				listing.own_urls.push(this.value);
			}
		});

		$('.seek').each(function () {
			if (this.checked) {
				listing.seek_urls.push(this.value);
			}
		});

		var error = false;
		if (isNaN(listing.offer_amt)) {
			$('#alerts').append(alertBootstrap('danger', 'invalid offer topup amount.'));
			error = true;
		} else if (isNaN(listing.request_amt)) {
			$('#alerts').append(alertBootstrap('danger', 'invalid request topup amount.'));
			error = true;
		} else if (listing.offer_amt > 0 && listing.request_amt > 0) {
			$('#alerts').append(alertBootstrap('danger', 'you cannot offer and request a topup amount at the same time.'));
			error = true;
		} else if (!listing.own_urls.length && !listing.seek_urls.length) {
			$('#alerts').append(alertBootstrap('danger', 'listing cannot be empty.'));
			error = true;
		} else if ((listing.own_urls.length || listing.offer_amt > 0) && !listing.seek_urls.length && listing.request_amt == 0) {
			$('#alerts').append(alertBootstrap('danger', 'add a topup amount and/or games you want to trade for.'));
			error = true;
		} else if (!listing.own_urls.length  && listing.offer_amt == 0 && (listing.seek_urls.length || listing.request_amt > 0)) {
			$('#alerts').append(alertBootstrap('danger', 'add a topup amount and/or games you want to trade away.'));
			error = true;
		} else {
			$.ajax({
				type: 'POST',
				url: '/listings/search',
				data: JSON.stringify(listing),
				contentType: 'application/json',
				success: function(data, textStatus, jqXHR) {
					console.log(data);
					console.log(textStatus);
					console.log(jqXHR);

					$('#search-div').fadeTo(500, 0).slideUp(500, function() {
						$(this).remove();
					});
					$('#search-results').append(data);
				},
				error: function(jqXHR, textStatus, errorThrown) {
					console.log(jqXHR);
					console.log(textStatus);
					console.log(errorThrown);
					var errors = eval(jqXHR.responseText);

					for (var i = 0; i < errors.length; i ++) {
						$('#alerts').append(alertBootstrap('danger', errors[i]));
					error = true;
					}
				}
			});

			if (error) {
				$('#form :input').prop('disabled', false);
			}
		}
	});

	$(document).ready(function(){
		// only allow numbers, backspaces, deletes, tabs to be typed in .price fields
		$(".price").keydown(function (event) {
			if (event.shiftKey) {
				event.preventDefault();
			}

			if (event.keyCode == 46 || event.keyCode == 8 || event.keyCode == 9) {
			}
			else {
				if (event.keyCode < 95) {
					if (event.keyCode < 48 || event.keyCode > 57) {
						event.preventDefault();
					}
				}
				else {
					if (event.keyCode < 96 || event.keyCode > 105) {
						event.preventDefault();
					}
				}
			}
		});
	});

	var own_url = '{{ own_url }}';
	var seek_url = '{{ seek_url }}';

	$(document).ready(function(){
		if (own_url != '' || seek_url != '') {
			$('#form :input').prop('disabled', true);

			var listing = {
				own_urls: [],
				seek_urls: [],
				offer_amt: Number.MAX_VALUE,
				request_amt: 0,
			};

			if (own_url != '') {
				listing.own_urls.push(own_url);
			} else {
				listing.seek_urls.push(seek_url);
			}

			$.ajax({
				type: 'POST',
				url: '/listings/search',
				data: JSON.stringify(listing),
				contentType: 'application/json',
				success: function(data, textStatus, jqXHR) {
					console.log(data);
					console.log(textStatus);
					console.log(jqXHR);

					$('#search-div').fadeTo(500, 0).slideUp(500, function() {
						$(this).remove();
					});
					$('#search-results').append(data);
				},
				error: function(jqXHR, textStatus, errorThrown) {
					console.log(jqXHR);
					console.log(textStatus);
					console.log(errorThrown);
					var errors = eval(jqXHR.responseText);

					for (var i = 0; i < errors.length; i++) {
						$('#alerts').append(alertBootstrap('danger', errors[i]));
					$('#form :input').prop('disabled', false);
					}
				}
			});
		}
	});
</script>
<script>
	$('#nav-list').addClass("active");
	$('#nav-list-search').addClass("active");
</script>
{% endblock %}