{% extends "base.html" %}
{% block content %}
<div id="search-div">
	<div class="page-header">
		<h1>
			search listings
			<a class="btn btn-default" href="/listings/add">
				<span class="glyphicon glyphicon-plus"></span>
			</a>
		</h1>
	</div>
	<div id="alerts">
		{% if not inventory.count() and not playlist.count() %}
		<div class="alert alert-info">
			no games in your inventory and playlist!
		</div>
		{% endif %}
	</div>
	{% if inventory.count() or playlist.count() %}
	<form id="form" class="form-horizontal" role="form">
	<div class="row">
		<div class="col-md-6">
			<div class="panel panel-primary">
				<div class="panel-heading">
					<h3 class="panel-title">inventory</h3>
				</div>
				{% if inventory.count() %}
				<div class="table-responsive">
					<table class="sortable table table-bordered table-striped">
						<thead>
							<tr>
								<th class="sorttable_nosort" width="10%" style="text-align: left"></th>
								<th width="75%" style="text-align: left">title</th>
								<th width="15%">platform</th>
							</tr>
						</thead>
						<tbody>
							{% for game in inventory %}
							<tr id="{{ game.key.urlsafe() }}">
								<td width="10%"><input id="{{ game.key.urlsafe() }}" type="checkbox" class="own"></td>
								<td width="75%" style="text-align: left">{{ game.title }}</td>
								<td width="15%">{{ game.platform }}</td>
							</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>
				{% else %}
				<div class="panel-body">
					<div class="alert alert-info">
						no games in your inventory!
						<a class="btn btn-default btn-sm" href="/inventory/add">
							<span class="glyphicon glyphicon-plus"></span>
						</a>
					</div>
				</div>
				{% endif %}
			</div>
		</div>
		<div class="col-md-6">
			<div class="panel panel-primary">
				<div class="panel-heading">
					<h3 class="panel-title">playlist</h3>
				</div>
				{% if playlist.count() %}
				<div class="table-responsive">
					<table class="sortable table table-bordered table-striped">
						<thead>
							<tr>
								<th class="sorttable_nosort" width="10%" style="text-align: left"></th>
								<th width="75%" style="text-align: left">title</th>
								<th width="15%">platform</th>
							</tr>
						</thead>
						<tbody>
							{% for game in playlist %}
							<tr id="{{ game.key.urlsafe() }}">
								<td width="10%"><input id="{{ game.key.urlsafe() }}" type="checkbox" class="seek" ></td>
								<td width="75%" style="text-align: left">{{ game.title }}</td>
								<td width="15%">{{ game.platform }}</td>
							</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>
				{% else %}
				<div class="panel-body">
					<div class="alert alert-info">
						no games in your playlist!
						<a class="btn btn-default btn-sm" href="/playlist/add">
							<span class="glyphicon glyphicon-plus"></span>
						</a>
					</div>
				</div>
				{% endif %}
			</div>
		</div>
	</div>
	<div class="pull-right">
		<button id="submit" type="button" class="btn btn-default">
			<span class="glyphicon glyphicon-search"></span>
		</button>
	</div>
	</form>
	{% endif %}
</div>
<div id="search-results"></div>
<script>
	function search() {
		clearAlerts();
		$('#form :input').prop('disabled', true);

		var listing = {
			own_urls: [],
			seek_urls: [],
		};

		$('.own').each(function () {
			if (this.checked) {
				listing.own_urls.push(this.id);
			}
		});

		$('.seek').each(function () {
			if (this.checked) {
				listing.seek_urls.push(this.id);
			}
		});

		var error;
		if (!listing.own_urls.length && !listing.seek_urls.length) {
			$('#alerts').append(alertBootstrap('danger', 'listing cannot be empty.'));
			error = true;
		} else {
			$.ajax({
				type: 'POST',
				url: '/listings/search',
				data: JSON.stringify(listing),
				contentType: 'application/json',
				success: function(data, textStatus, jqXHR) {
					console.log(data);
					console.log(textStatus);
					console.log(jqXHR);

					$('#search-div').fadeTo(500, 0).slideUp(500, function() {
						$(this).remove();
					});
					$('#search-results').append(data);
				},
				error: function(jqXHR, textStatus, errorThrown) {
					console.log(jqXHR);
					console.log(textStatus);
					console.log(errorThrown);
					var errors = eval(jqXHR.responseText);

					for (var i = 0; i < errors.length; i++) {
						$('#alerts').append(alertBootstrap('danger', errors[i]));
					}
					error = true;
				}
			});
		}

		if (error) {
			$('#form :input').prop('disabled', false);
		}
	}

	$('#submit').click(function() {
		search();
	});

	$(document).ready(function(){
		// only allow numbers, backspaces, deletes, tabs to be typed in .price fields
		$(".price").keydown(function (event) {
			if (event.shiftKey) {
				event.preventDefault();
			}

			if (event.keyCode == 46 || event.keyCode == 8 || event.keyCode == 9) {
			}
			else {
				if (event.keyCode < 95) {
					if (event.keyCode < 48 || event.keyCode > 57) {
						event.preventDefault();
					}
				}
				else {
					if (event.keyCode < 96 || event.keyCode > 105) {
						event.preventDefault();
					}
				}
			}
		});
	});

	{% if own_url or seek_url %}
	$(document).ready(function(){
		$('input[id={{ own_url }}]').prop('checked', true);
		$('input[id={{ seek_url }}]').prop('checked', true);

		search();
	});
	{% endif %}
</script>
<script>
	$('#nav-list').addClass("active");
	$('#nav-list-search').addClass("active");
</script>
{% endblock %}