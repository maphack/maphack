{% extends "base.html" %}
{% block content %}

<script src="//code.jquery.com/ui/1.10.4/jquery-ui.js"></script>

<script type="text/javascript">

  function addNewListing() {
    // arrays representing the inventory and playlist of the user
    var inventory = [];
    var playlist = [];
    
    // populate the inventory and playlist representations with the info for each game
    {% for game in inventory %}
      inventory.push({ Title: "{{game.title}}", Platform: "{{game.platform}}", Id: "{{game.key.id()}}"});
    {% endfor %} 
    console.log(inventory);    
    {% for game in playlist %}
      playlist.push({ Title: "{{game.title}}", Platform: "{{game.platform}}", Id: "{{game.key.id()}}"});
    {% endfor %} 

    console.log(playlist);

    // initialize newTrade object to be passed as JSON later in POST request
    var newTrade = {
      toTrade: [],
      toReceive: [],
      topUp: parseFloat(document.getElementById("topup").value),
    };

    // add checked items in the inventory to the trade
    for (var i = 0; i < inventory.length; i++) {
      // alert("loop counter: " + i);
      if (document.getElementById("inv" + i).checked) {
        newTrade.toTrade.push(inventory[i]);
      } 
    }

    // add checked items in the playlist to the trade
    for (var i = 0; i < playlist.length; i++) {
      if (document.getElementById("plist" + i).checked) {
        newTrade.toReceive.push(playlist[i]);
      }      
    }

    console.log(newTrade);
    alert('attempting to post new Listing..');
    $.ajax({
      type: "POST",
      url: "/listings",
      data: JSON.stringify(newTrade),
      contentType: "application/json",
      success: function(){alert('success');},
      failure: function() {
          alert('failure');
      }
    });
  }
</script>

<h4>Make a new listing:</h4>
<h5>I want to trade</h5>
<div class="top-pad-one">	
	<div class="totrade" style="width: 550px; min-height: 200px; height: auto; margin:0 auto; display:inline-block; " align="center">
    <table id="tobetraded" border="1" style="width: 550px;">
      <thead>
        <tr><th></th><th>Title</th><th>Platform</th></tr>
      </thead>
      {% for game in inventory %}
      <tbody>
        <tr>
          <td><input id="inv{{loop.index0}}" type="checkbox"></td>
          <td>{{ game.title }}</td>
          <td>{{ game.platform }}</td>
        </tr>
      </tbody>
      {% endfor %}
    </table>
  </div>
  <div style="width: 20px; height: 20px; margin-right:7px; display:inline-block; vertical-align:top;" align="center">
    for 
  </div>
  <div class="toget" style="width: 550px;min-height: 200px; height: auto; margin:0 auto; display:inline-block;" align="center">
    <table id="tobereceived" border="1" style="width: 550px;">
      <thead>
        <tr><th></th><th>Title</th><th>Platform</th></tr>
      </thead>
      {% for game in playlist %}
      <tbody>
        <tr>
          <td><input id="plist{{loop.index0}}" type="checkbox"></td>
          <td>{{ game.title }}</td>
          <td>{{ game.platform }}</td>
        </tr>
      </tbody>
      {% endfor %}
    </table>
  </div>
    
  <div class="row-fluid">
    top-up amount <input id="topup" class="input-xlarge" type="text" name="topup" value="0" required><br>
  </div>
  <button onclick="addNewListing()">add listing</button>
</div>

<div>
  <h4>Current Listings</h4>
  {% for listing in listings %}
  <table class="table table-bordered table-striped">
    <thead>
      <tr>
        <th width = "60%">My titles</th>
        <th width = "40%">My platforms</th>
      </tr>
    </thead>
    <tbody>
    {% for game in listing.away_list %}
      <tr>
        <td width = "60%">{{ game.title }}</td>
        <td width = "40%">{{ game.platform }}</td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
  {% endfor %}
</div>
{% endblock %}